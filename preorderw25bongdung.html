<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tra cứu đơn hàng</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #121212;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: #1e1e1e;
      border: 2px solid #FFD700;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      padding: 25px;
      width: 90%;
      max-width: 650px;
      text-align: center;
    }
    header {
      font-size: 1.6rem;
      font-weight: 600;
      color: #FFD700;
      margin-bottom: 20px;
    }
    .search-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    input[type="tel"] {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #FFD700;
      background: #121212;
      color: #fff;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #FFD700;
      color: black;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #e6c200;
    }
    .results {
      margin-top: 20px;
      text-align: left;
    }
    .order {
      background: #2a2a2a;
      border: 1px solid #FFD700;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .order h3 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #FFD700;
    }
    .order p {
      margin: 6px 0;
    }
    a {
      color: #FFD700;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .message {
      background: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #FFD700;
      color: #FFD700;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>TRA CỨU ĐƠN HÀNG</header>
    <div class="search-box">
      <input type="tel" id="phone" placeholder="Nhập số điện thoại" inputmode="numeric">
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
        <button onclick="searchOrder()">Tìm đơn</button>
        <button onclick="loadData()">Refresh Data</button>
      </div>
    </div>
    <div class="results" id="results"></div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS68LmtizleGjeH66aUUo9B2YC75ye4ZjfIfjR7lCe17JPAXqisC_FKkoLtVpfsUtwvLs0yObWmIdM4/pub?gid=272659167&single=true&output=csv";
    let data = [];

    async function loadData() {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = `<div class="message">Đang tải dữ liệu...</div>`;
      try {
        const res = await fetch(sheetUrl);
        const text = await res.text();
        const rows = text.split("\n").map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)); // tách csv an toàn
        data = rows;
        resultsDiv.innerHTML = `<div class="message">Dữ liệu đã được refresh thành công!</div>`;
      } catch (e) {
        resultsDiv.innerHTML = `<div class="message">Không thể tải dữ liệu. Vui lòng thử lại.</div>`;
      }
    }

    function normalizePhone(phone) {
      let p = phone.replace(/\D/g, "");
      if (p.startsWith("84")) return "0" + p.slice(2);
      if (p.startsWith("0084")) return "0" + p.slice(4);
      if (p.startsWith("+84")) return "0" + p.slice(3);
      return p;
    }

    function searchOrder() {
      const phoneInput = document.getElementById("phone").value.trim();
      const phone = normalizePhone(phoneInput);
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (!phone) {
        resultsDiv.innerHTML = `<div class="message">⚠️ Vui lòng nhập số điện thoại.</div>`;
        return;
      }

      if (data.length === 0) {
        resultsDiv.innerHTML = `<div class="message">⚠️ Dữ liệu chưa tải. Nhấn "Refresh Data" để tải lại.</div>`;
        return;
      }

      const orders = data.filter((row, idx) => idx > 0 && normalizePhone(row[1]) === phone);

      if (orders.length === 0) {
        resultsDiv.innerHTML = `<div class="message">❌ Không tìm thấy đơn hàng cho số ${phone}.</div>`;
        return;
      }

      orders.forEach(row => {
        let html = `<div class="order">
          <h3>THÔNG TIN ĐƠN HÀNG</h3>
          <p><strong>Facebook:</strong> <a href="${row[3]}" target="_blank">${row[2]}</a></p>`;

        if (row[5]) html += `<p><strong>Số lượng Jacket:</strong> ${row[5]}</p>`;
        if (row[6]) html += `<p><strong>Marking Jacket:</strong> ${row[6]}</p>`;
        if (row[7]) html += `<p><strong>Số lượng Jersey đen:</strong> ${row[7]}</p>`;
        if (row[8]) html += `<p><strong>Marking Jersey đen:</strong> ${row[8]}</p>`;
        if (row[9]) html += `<p><strong>Số lượng Jersey cam:</strong> ${row[9]}</p>`;
        if (row[10]) html += `<p><strong>Marking Jersey cam:</strong> ${row[10]}</p>`;
        if (row[11]) html += `<p><strong>Muffler:</strong> ${row[11]}</p>`;
        if (row[12]) html += `<p><strong>Keyring Uni:</strong> ${row[12]}</p>`;
        if (row[13]) html += `<p><strong>Keyring Khăn:</strong> ${row[13]}</p>`;
        if (row[14]) html += `<p><strong>Marking lẻ:</strong> ${row[14]}</p>`;
        if (row[15]) html += `<p><strong>Số tiền đã chuyển:</strong> ${row[15]}</p>`;
        if (row[17]) html += `<p><strong>Ghi chú:</strong> ${row[17]}</p>`;

        html += "</div>";
        resultsDiv.innerHTML += html;
      });
    }

    // auto load dữ liệu khi mở web
    loadData();
  </script>
</body>
</html>
