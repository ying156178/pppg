<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra cứu đơn doll - Wangko, PeanGonix, Peminia</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
<style>
:root {
  --blue-dark: #0b1e3f;
  --blue-accent: #1d4ed8;
  --blue-light: #60a5fa;
  --text-light: #e0e7ff;
  --bg-card: #132a53;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Montserrat",sans-serif;}
body{
  background: linear-gradient(135deg,#0b1e3f,#1e3a8a);
  color: var(--text-light);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:2rem;
}
h1{text-align:center;font-size:1.8rem;margin-bottom:1.5rem;color:#93c5fd;text-transform:uppercase;letter-spacing:1px;}
.search-box{
  display:flex;flex-direction:column;align-items:center;
  background: var(--bg-card);padding:2rem;border-radius:1rem;box-shadow:0 4px 20px rgba(0,0,0,0.4);
  width:100%;max-width:500px;
}
.search-box input{
  padding:0.75rem 1rem;border-radius:0.5rem;border:none;outline:none;
  width:100%;font-size:1rem;margin-bottom:1rem;background:#1e3a8a;color:white;
}
.btn-group{display:flex;gap:1rem;width:100%;}
button{
  flex:1;padding:0.75rem;background: var(--blue-accent);color:white;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;transition:0.3s;
}
button:hover{background: var(--blue-light);}
.result{margin-top:2rem;width:100%;max-width:900px;}
.fb-name a{color: var(--blue-light);text-decoration:none;font-weight:600;}
.fb-name a:hover{text-decoration:underline;}
.tabs{display:flex;justify-content:space-between;gap:0.5rem;margin-top:1.5rem;flex-wrap:wrap;}
.tab{flex:1;text-align:center;background:#1e3a8a;color:#bfdbfe;padding:0.75rem;border-radius:0.5rem;cursor:pointer;transition:0.3s;font-weight:600;min-width:100px;}
.tab.active{background: var(--blue-light);color:#0b1e3f;}
.tab:hover{background:#3b82f6;}
.tab-content{display:none;background:var(--bg-card);margin-top:1rem;padding:1rem 1.5rem;border-radius:0.75rem;line-height:1.6;box-shadow:0 4px 10px rgba(0,0,0,0.3);}
.tab-content.active{display:block;}
.summary{background: var(--bg-card);margin-top:1.5rem;padding:1rem 1.5rem;border-radius:0.75rem;box-shadow:0 4px 10px rgba(0,0,0,0.3);line-height:1.6;}
@media (max-width:768px){.tab{flex:1 1 calc(33.33% - 0.5rem);font-size:0.9rem;}}
</style>
</head>
<body>
<div class="search-box">
<h1>THÔNG TIN ĐƠN DOLL WANGKO PEANGONIX PEMINIA</h1>
<input type="text" id="phoneInput" placeholder="Nhập 9 số cuối của SĐT..." />
<div class="btn-group">
<button onclick="fetchData()">Tra cứu</button>
<button onclick="refreshData()">Làm mới</button>
</div>
</div>

<div class="result" id="result"></div>

<script>
const sheetUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vS4oRIqtNL82DDarVOcWUq7UlXEteJgOnOD6qoyK85CVsqBSUhqNcRrzxzkjO3GD49u11YHQOgp6mPR/pub?gid=413464906&single=true&output=csv";
let csvData=[];

async function fetchCSV(){
  const res = await fetch(sheetUrl);
  const text = await res.text();
  csvData = text.split("\n").map(r=>r.split(","));
}

function formatMoney(num){
  if(!num || isNaN(num) || num===0) return "";
  return num.toLocaleString("vi-VN");
}

function processDoll(rows, slIndex, optIndex, ttIndex, moneyIndex){
  const grouped = {};
  rows.forEach(r=>{
    const opt = r[optIndex];
    if(!grouped[opt]) grouped[opt]=[];
    grouped[opt].push(r);
  });
  const result=[];
  Object.keys(grouped).forEach(opt=>{
    const group = grouped[opt];
    let hasCoc=false, hasHoan=false;
    group.forEach(r=>{
      const tt = r[ttIndex] || "";
      if(tt.includes("Cọc")) hasCoc=true;
      if(tt.includes("Hoàn")) hasHoan=true;
    });
    const ttFinal = (hasCoc && hasHoan) ? "Chuyển khoản full" : (group[0][ttIndex] || "");
    let slFinal=0;
    if(hasCoc && hasHoan && group.length>1){
      slFinal = parseInt(group[0][slIndex]) || 0;
    } else {
      slFinal = group.reduce((acc,r)=> acc + (parseInt(r[slIndex])||0),0);
    }
    if(slFinal === 0) return; // lọc option =0
    const moneyFinal = group.reduce((acc,r)=> acc + (parseFloat(r[moneyIndex])||0),0);
    result.push({sl: slFinal, opt: opt, tt: ttFinal, money: moneyFinal});
  });
  return result;
}

async function fetchData(){
  if(csvData.length===0) await fetchCSV();
  const phone = document.getElementById("phoneInput").value.trim();
  if(!phone){ alert("Vui lòng nhập số điện thoại!"); return; }

  const foundRows = csvData.filter(r=>{
    const phoneCol = r[1]?.replace(/\D/g,"");
    return phoneCol && phoneCol.endsWith(phone);
  });

  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML="";
  if(foundRows.length===0){
    resultDiv.innerHTML="<p style='text-align:center;color:#fca5a5;'>Không tìm thấy thông tin.</p>";
    return;
  }

  const firstRow = foundRows[0];
  const fbName = firstRow[2];
  const fbLink = firstRow[3];

  const wangkoData = processDoll(foundRows,5,6,7,8);
  const peanData = processDoll(foundRows,9,10,11,12);
  const peminiaData = processDoll(foundRows,13,14,15,16);

  const totalMoney = foundRows.reduce((acc,r)=> acc + (parseFloat(r[17])||0),0);
  const note = firstRow[19];

  const tabs=[];
  if(wangkoData.length>0) tabs.push({name:"Wangko", data:wangkoData});
  if(peanData.length>0) tabs.push({name:"PeanGonix", data:peanData});
  if(peminiaData.length>0) tabs.push({name:"Peminia", data:peminiaData});

  const tabButtons = tabs.map((t,i)=> `<div class="tab ${i===0?"active":""}" onclick="showTab(${i})">${t.name}</div>`).join("");
  const tabContents = tabs.map((t,i)=>{
    return `<div class="tab-content ${i===0?"active":""}" id="tab-${i}">
      ${t.data.map(d=>`
        <p><strong>Số lượng:</strong> ${d.sl}</p>
        <p><strong>Option:</strong> ${d.opt}</p>
        <p><strong>Tình trạng:</strong> ${d.tt}</p>
        ${formatMoney(d.money) ? `<p><strong>Số tiền đã chuyển cho ${t.name}:</strong> ${formatMoney(d.money)}</p>` : ""}
        <hr style="border-color:#1e3a8a;">
      `).join("")}
    </div>`;
  }).join("");

  resultDiv.innerHTML=`
    <div class="fb-name" style="text-align:center;margin-top:2rem;">
      <a href="${fbLink}" target="_blank">${fbName}</a>
    </div>
    <div class="tabs">${tabButtons}</div>
    ${tabContents}
    <div class="summary">
      ${formatMoney(totalMoney) ? `<p><strong>Tổng số tiền đã chuyển khoản:</strong> ${formatMoney(totalMoney)}</p>` : ""}
      <p><strong>Note:</strong> ${note || "Không có"}</p>
    </div>
  `;
}

function showTab(index){
  document.querySelectorAll(".tab").forEach((t,i)=> t.classList.toggle("active", i===index));
  document.querySelectorAll(".tab-content").forEach((c,i)=> c.classList.toggle("active", i===index));
}

function refreshData(){
  csvData=[];
  document.getElementById("result").innerHTML="";
  alert("Dữ liệu đã được làm mới!");
}
</script>
</body>
</html>
