<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tra cứu doll CK</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #0f0f1a;
      --card: #1a1a2e;
      --accent: #a78bfa;
      --accent-2: #34d399;
      --text: #f3f4f6;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Montserrat', sans-serif;
      background: var(--bg); color: var(--text);
      display: flex; justify-content: center; padding: 20px;
    }
    main {
      width: 100%; max-width: 500px;
      background: var(--card); padding: 20px;
      border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }
    h1 { margin: 0; font-size: 1.5rem; }
    .small { font-size: 0.9rem; color: var(--muted); }
    .divider {
      margin: 16px 0; height: 1px;
      background: rgba(255,255,255,0.1);
    }
    label { font-weight: 600; display:block; margin-bottom:6px; }
    input {
      width: 100%; padding: 10px 14px;
      border-radius: 8px; border: none;
      background: rgba(255,255,255,0.08); color: var(--text);
      font-size: 1rem;
    }
    button {
      margin-top: 12px; width: 100%;
      padding: 12px; border: none; border-radius: 8px;
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      color: white; font-weight: 600; cursor: pointer;
    }
    .status { margin-top: 10px; font-size: 0.9rem; }
    .status.ok { color: var(--accent-2); }
    .status.error { color: #f87171; }
    .result { margin-top: 20px; display: none; }
    .result.show { display:block; }
    .row { margin-bottom: 8px; }
    .label { font-weight: 600; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
    .chip {
      background: rgba(255,255,255,0.08);
      padding: 4px 10px; border-radius:999px;
      font-size: 0.85rem;
    }
    .progressBar{
      width:100%; height:18px; border-radius:999px;
      background:rgba(255,255,255,0.07); overflow:hidden;
    }
    .progressFill{
      height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2));
      transition:width .5s ease;
    }
    .footer { margin-top:20px; text-align:right; }
    .footer a { color: var(--accent); font-size:0.9rem; text-decoration:none; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Tra cứu doll CK</h1>
      <div class="small">Dự án 50 doll</div>

      <!-- Thanh tiến độ tổng -->
      <div class="progressBar" style="margin-top:12px">
        <div class="progressFill" id="globalProgressFill"></div>
      </div>
      <div class="small" id="globalProgressText">0 / 50 doll đã CK</div>
    </header>

    <div class="divider"></div>

    <form id="lookupForm">
      <label for="phone">Nhập số điện thoại</label>
      <input type="text" id="phone" placeholder="VD: 098xxxxxxx"/>
      <button type="submit">Tra cứu</button>
    </form>

    <div id="status" class="status"></div>

    <section id="result" class="result">
      <div class="row"><div class="label">Tên Facebook:</div><div id="fbName">—</div></div>
      <div class="row"><div class="label">Tổng số doll lấy:</div><div id="totalDolls">—</div></div>
      <div class="row"><div class="label">Chi tiết:</div>
        <div class="chips">
          <span class="chip" id="noBone">— doll không xương</span>
          <span class="chip" id="withBone">— doll có xương</span>
        </div>
      </div>
      <div id="multiNote" class="small" style="display:none">
        Có nhiều dòng khớp SĐT của bạn, hệ thống đã <strong>gộp số lượng</strong> theo tất cả dòng khớp.
      </div>
    </section>

    <div class="footer">
      <a href="#" id="refreshBtn">Làm mới dữ liệu</a>
    </div>
  </main>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8BbOZIGFLYc5iqesG38ysAG8tOXDNqFzjLmodFIrYyIImc4xwLwapjJRIlM2/pub?output=csv";
    let sheetData = [];

    function el(id){ return document.getElementById(id); }

    function setStatus(msg, cls=''){ 
      const s = el('status'); 
      s.textContent = msg; s.className = 'status '+cls;
    }

    // Tải sheet
    async function loadSheet(){
      try{
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const rows = text.split("\n").map(r=>r.split(","));
        sheetData = rows;

        // tính tổng CK
        let globalTotal = 0;
        sheetData.forEach((row,i)=>{
          if(i===0) return; // header
          const noBone = parseInt(row[4]||0,10);
          const withBone = parseInt(row[5]||0,10);
          globalTotal += (noBone + withBone);
        });
        const percent = Math.min(100,(globalTotal/50)*100);
        el('globalProgressFill').style.width = percent+'%';
        el('globalProgressText').textContent = `${globalTotal} / 50 doll đã CK`;

        setStatus("Dữ liệu đã tải xong, nhập SĐT để tra cứu.", "ok");
      }catch(e){
        setStatus("Lỗi tải dữ liệu: "+e, "error");
      }
    }

    // Tra cứu
    function lookup(phone){
      if(!sheetData.length){ setStatus("Chưa có dữ liệu.", "error"); return; }
      let matches = [];
      sheetData.forEach((row,i)=>{
        if(i===0) return;
        if((row[1]||"").includes(phone)){
          matches.push(row);
        }
      });
      if(matches.length===0){
        setStatus("Không tìm thấy dữ liệu cho SĐT này.", "error");
        el('result').classList.remove('show');
        return;
      }
      let sumE=0,sumF=0,names=[];
      matches.forEach(r=>{
        sumE += parseInt(r[4]||0,10);
        sumF += parseInt(r[5]||0,10);
        if(r[2]) names.push(r[2]);
      });
      el('fbName').textContent = names.join(", ") || "—";
      el('totalDolls').textContent = sumE+sumF;
      el('noBone').textContent = `${sumE} doll không xương`;
      el('withBone').textContent = `${sumF} doll có xương`;
      el('multiNote').style.display = matches.length>1?"block":"none";
      el('result').classList.add('show');
      setStatus(`Tìm thấy ${matches.length} dòng khớp.`, "ok");
    }

    // Form
    document.getElementById('lookupForm').addEventListener('submit',e=>{
      e.preventDefault();
      const phone = el('phone').value.trim();
      if(!phone){ setStatus("Vui lòng nhập số điện thoại.", "error"); return; }
      lookup(phone);
    });

    // Refresh
    el('refreshBtn').addEventListener('click',e=>{
      e.preventDefault();
      setStatus("Đang tải lại dữ liệu...");
      loadSheet();
    });

    loadSheet();
  </script>
</body>
</html>
