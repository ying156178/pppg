<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tra cứu doll Chớp Vương</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827ee;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#7c3aed;
      --accent-2:#22d3ee;
      --error:#ef4444;
      --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: 'Montserrat', sans-serif;
      background: linear-gradient(180deg, #0b1020 0%, #0f172a 60%);
      color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:min(860px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:24px; padding:28px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    h1{font-size:clamp(22px, 2.8vw, 32px); margin:0 0 6px; font-weight:700}
    .sub{color:var(--muted); margin-bottom:22px; font-size:14px}
    form{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px}
    .field{flex:1 1 320px}
    input[type="tel"]{
      width:100%; padding:14px 16px; border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background:#0b1222; color:var(--text); font-size:16px;
      outline:none; transition: box-shadow .2s, border-color .2s;
    }
    input[type="tel"]:focus{border-color: var(--accent); box-shadow: 0 0 0 4px rgba(124,58,237,0.25)}
    button{
      padding:14px 18px; border-radius:14px;
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      border:none; color:white; font-weight:700; cursor:pointer;
    }
    .status{ font-size:14px; margin-top:8px }
    .status.ok{ color:var(--ok) }
    .status.error{ color:var(--error) }
    .small{ font-size:13px; color:var(--muted) }
    .divider{ height:1px; background:rgba(255,255,255,0.08); margin:14px 0 }
    .row{ display:flex; gap:10px; margin:10px 0 }
    .label{ min-width:150px; font-weight:600; color:#c7d2fe }
    .value{ flex:1 }
    .chip{ padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.07); font-size:13px }
    /* Progress bar */
    .progress-container{ margin-top:16px }
    .progress-label{ margin-bottom:6px; font-size:14px }
    .progress-bar{
      width:100%; height:18px; border-radius:999px;
      background:rgba(255,255,255,0.1); overflow:hidden;
    }
    .progress-fill{
      height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2));
      width:0%; transition:width .4s ease;
    }
    .footer{ margin-top:16px; text-align:right }
    .footer a{ color:#a5b4fc; font-size:13px; text-decoration:none }
  </style>
</head>
<body>
  <main class="card">
    <h1>Tra cứu doll Chớp Vương</h1>
    <div class="sub">Nhập số điện thoại để xem thông tin đặt doll.</div>

    <form id="lookupForm">
      <div class="field">
        <input id="phoneInput" type="tel" inputmode="numeric" placeholder="VD: 0987 654 321" required>
      </div>
      <button type="submit">Tra cứu</button>
    </form>

    <div id="status" class="status small"></div>
    <div class="divider"></div>

    <section id="result" style="display:none">
      <div class="row"><div class="label">Tên Facebook:</div><div class="value" id="fbName">—</div></div>
      <div class="row"><div class="label">Tổng số doll lấy:</div><div class="value" id="totalDolls">—</div></div>
      <div class="row"><div class="label">Chi tiết:</div>
        <div class="value">
          <span class="chip" id="noBone">— doll không xương</span>
          <span class="chip" id="withBone">— doll có xương</span>
        </div>
      </div>
      <div class="row"><div class="label">Lưu ý:</div><div class="value" id="note">—</div></div>
    </section>

    <div class="progress-container">
      <div class="progress-label" id="progressText">Đã có 0 doll đã chuyển khoản</div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>

    <div class="footer">
      <a href="#" id="refreshBtn">Làm mới dữ liệu</a>
    </div>
  </main>

  <script>
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQG2ouER8Ba9BT93CiKGE93hsx6eV415tZgbdm1MR1fsnsC0N8vx13T3C5YZfzURDSjnHOdXDNxw8CS/pub?gid=542266316&single=true&output=csv';
    const state = { rows: [] };
    const el = (id)=>document.getElementById(id);

    function setStatus(msg,type=''){ 
      el('status').textContent=msg; 
      el('status').className=`status small ${type}`;
    }

    function parseCSV(text){
      const rows=[]; let cur=['']; let inQuotes=false;
      for(const ch of text){
        if(ch==='"') inQuotes=!inQuotes;
        else if(ch===',' && !inQuotes) cur.push('');
        else if((ch==='\n'||ch==='\r') && !inQuotes){ if(cur.length>1||cur[0]) rows.push(cur); cur=['']; }
        else cur[cur.length-1]+=ch;
      }
      if(cur.length>1||cur[0]) rows.push(cur);
      return rows.map(r=>r.map(c=>c.replace(/^\ufeff/,'').trim()));
    }

    function normalizePhone(raw){
      if(!raw) return '';
      let digits = raw.replace(/\D+/g,'');
      if(digits.startsWith('84') && digits.length>=10) digits='0'+digits.slice(2);
      if(digits.length>11) digits=digits.slice(-11);
      return digits;
    }

    async function loadSheet(){
      try{
        setStatus("Đang tải dữ liệu...");
        const res=await fetch(SHEET_CSV_URL,{cache:'no-store'});
        const text=await res.text();
        const rows=parseCSV(text);
        state.rows=rows.slice(1);
        setStatus("Dữ liệu đã sẵn sàng","ok");
        updateProgress();
      }catch(e){setStatus("Lỗi tải dữ liệu","error");}
    }

    function lookup(phone){
      const q=normalizePhone(phone); if(!q) return null;
      let sumE=0,sumF=0,names=new Set(),notes=new Set();
      for(const r of state.rows){
        const ph=normalizePhone(r[1]||''); if(!ph) continue;
        if(ph===q||ph.endsWith(q)||q.endsWith(ph)){
          sumE+=Number(r[4]||0); sumF+=Number(r[5]||0);
          if(r[2]) names.add(r[2]);
          if(r[8]) notes.add(r[8]);
        }
      }
      return {sumE,sumF,names:[...names],notes:[...notes]};
    }

    function renderResult(data){
      if(!data||(!data.sumE&&!data.sumF)){
        el('result').style.display='none';
        setStatus("Không tìm thấy dữ liệu","error"); return;
      }
      el('result').style.display='block';
      el('fbName').textContent=data.names.join(', ')||'—';
      el('totalDolls').textContent=data.sumE+data.sumF;
      el('noBone').textContent=`${data.sumE} doll không xương`;
      el('withBone').textContent=`${data.sumF} doll có xương`;
      el('note').textContent=data.notes.join('; ')||'—';
      setStatus("Tìm thấy dữ liệu","ok");
    }

    function updateProgress(){
      let total=0;
      for(const r of state.rows){
        total+=Number(r[4]||0)+Number(r[5]||0);
      }
      const percent=Math.min(100,(total/50*100).toFixed(1));
      el('progressText').textContent=`Đã có ${total} doll đã chuyển khoản`;
      el('progressFill').style.width=percent+"%";
    }

    document.getElementById('lookupForm').addEventListener('submit',e=>{
      e.preventDefault();
      const phone=el('phoneInput').value;
      const data=lookup(phone);
      renderResult(data);
    });

    document.getElementById('refreshBtn').addEventListener('click', e=>{
      e.preventDefault();
      loadSheet();
    });

    loadSheet();
  </script>
</body>
</html>
